## Домашнее задание

Паттерны декомпозиции микросервисов

**Цель:**

В этом ДЗ вы разделите ваше приложение на несколько микросервисов с учетом будущих изменений.

**Описание/Пошаговая инструкция выполнения домашнего задания:**

Попробуйте сделать несколько вариантов разбиений и попробуйте их оценить. Выберите вариант, который вы будете реализовывать.

На выходе вы должны предоставить

1. Пользовательские сценарии
2. Общую схему взаимодействия сервисов.
3. Для каждого сервиса опишите назначение сервиса и его зону ответственности.
4. Опишите контракты взаимодействия сервисов друг с другом.

## Решение

### Краткое описание проекта

Кратко о текущем сервисе, который будем распиливать на микросервисы:

Монолит сервис - предоставляет собой систему лояльности для розничных магазинов.

Cервис занимается получением и хранением данных о пользователях и операциях, а также хранит бонусный счет каждого покупателя - есть логика списания и начисления бонусов на счет покупателя. Занимается информированием покупателей об операциях (через телеграм бот)), на по его карте лояльности (списания, начисления). Система начисляет бонусы на день рожденья, а также приветственные бонусы при соблюдении некоторых условий.

Источником данных является внешняя система, которая учитывает в себе розничные продажи, заказы с сайта, из соцсетей и маркетплейсов, отгрузки и приемки, товары и цены, финансы, клиенты и сотрудники, задачи и документы.

### 1. Пользовательские сценарии

#### 1.1 История: Для каждого покупателя должна быть возможность создать карту лояльности

Как покупатель розничного магазина

Чтобы использовать систему лояльности

Хочу иметь возможность завести карту лояльности и использовать систему лояльности и скидок в магазине при покупках


**Сценарий**: создание карты лояльности для покупателя

**Дано**: покупатель, у которого нет карты лояльности

И он хочет завести карту лояльности для дальнейших покупок

Продавец создает нового покупателя через внешнюю систему, заводит номер телефона, ФИО, дату рождения и пол покупателя

#### 1.2 История: Для каждого покупателя должна быть возможность накапливать бонусы на карту лояльности

Как покупатель розничного магазина

Чтобы накапливать бонусы на карте системы лояльности

Хочу иметь возможность копить бонусы для получения скидок при последующих покупок

**Сценарий**: накопления бонусов на карте лояльности

**Дано**: покупатель, у которого есть карта лояльности

Когда покупатель соврешает покупку, продавец может выбрать опцию копить бонусы

Продавец проводит покупку через внешнюю систему

Через поиск покупателя ищет карту лояльности клиента (по номеру телефона клиента либо по номер карты лояльности)

Выбирает нужного покупателя
После оплаты внешняя система отправляет созданную покупку в нашу систему

Наша система фиксирует покупку и совершает начисление бонусов и отправляетуведомлмение в телеграм бота клиента с инеформацией о количестве накопленных баллов в этой покупке

#### 1.3 История: Для каждого покупателя должна быть возможность списывать бонусы с карты лояльности

Как покупатель розничного магазина

Чтобы списывать бонусы с карты системы лояльности

Хочу иметь возможность получать скидку на покупке при использовании накомленных бонусов

**Сценарий**: списание бонусов по карте лояльности

**Дано**: покупатель, у которого есть карта лояльности

И у покупателя есть накопленные бонусы

Когда покупатель соврешает покупку, продавец может выбрать опцию списать бонусы

Продавец проводит покупку через внешнюю систему

Через поиск покупателя ищет карту лояльности клиента (по номеру телефона клиента либо по номер карты лояльности)

Выбирает нужного покупателя
После оплаты внешняя система отправляет созданную покупку в нашу систему

Наша система фиксирует покупку и совершает списание бонусов и отправляет уведомлмение в телеграм бота клиента с инеформацией о количестве списанных бонусов в этой покупке

### 2. Общая схема взаимодействия сервисов.

**Мой склад** - внешняя система для создание покупателей, покупок и возвратов установленная в точке розничных продаж - клиент сервиса это продавец.

**Loyalty API** - API для получения информации о создании покупателей, покупок и возвратов, принимает запрос и сохраняет всю информацию, публикует события для системы скоринга(подсчета бонусов для списания и начисления).

**Scoring Service** система скоринга - получает события о покупках и возвратах - она делает подсчеты, о том сколько можно списать бонусов, и сколько бонусов будет начислено при покупке.

**Jobs Service** - джобc система - она запускает процесс один раз в день и выбирает покупателей у которых скоро день рожденья и начисляет бонусы в честь дня рожденья.

**Notification Service** - система уведомлений в телегам бота - она умеет авторизовывать пользователя, предоставлять ему инфомрацию о движении бонусов по его карте лояльности, и дает возможность по запросу покупателя получение текущей информации о карте лояльности и о количестве бонусов на счету, а также автоматически присылает уведомления о движении бонусов.

Общая схема взаимоедствия такая:
Мой склад - делает вызовы в **Loyalty API**

**Loyalty API** - делает запросы на подсчеты бонусов покупаиелей в **Scoring Service**

**Scoring Service** - создает события для отправки сообщений в **Notification Service**

**Notification Service** - делает вызовы телеграм бот API, а также делает полинг новых запросов из телеграм бота API

**Jobs Service** - делает необходимые вычисления и отправляет запросы в **Scoring Service**

### 3. Описание для каждого сервиса и его зона ответственности.

* **Мой склад** - внешняя система, является источником данных о покупателях, покупках и возвратах. Зона ответсвенности создание покупателей, покупок и возвратов и отправка этих данных в Loyalty API.
* **Loyalty API** - внутренняя система, является фасадом для приема информации из сервиса **Мой склад.** Зона ответсвенности прием данных из сервиса **Мой склад** сохраннение информации о покупателях, их покупок и возвратах. А также возврат в систему Мой склад информации о покупателях, о возможности списать бонусы, а также о бонусах, которые будут начислены покупателю после совершения покупки.
* **Scoring Service** система скоринга - хранит в себе информацию о балансе карт лояльности покупателей, умеет считать сколько бонусов возможно списать с покупки или сколько бонусов будет начислено покупателю после соврешения покупки. Зона ответственности: бонусные балансы карт лояльности покупателей - списание и начисление.
* **Notification Service** - система уведомлений покупателей о движении бонусов по его карте лояльности и взаимодействия с чат ботом из телеграм с покупателем. Зона отвественности: отправка уведомлений покупателям, обработка запросов от покупателей из телеграм бота.
* **Jobs Service** - система делает вычисления в бекгруанде - вычисляем кому можно начислить бонусы в честь дня рождения. Зона отвественности: бекгруанд вычисления, работает по расписания и делает необходимые действия - на данный момент это только опредления покупателей, у которых скоро день рождения и начисления им бонусов.

#### 4. Опишите контракты взаимодействия сервисов друг с другом.

Система **Мой склад** делает вызовы в **Loyalty API**

Loyalty API имеет в себе следующие эндпоинты

##### Создание покупателя

```
POST Loyalty/counterparty
```

| Атрибут | Тип | Описание                                                                 |
| -------------- | ------ | -------------------------------------------------------------------------------- |
| id             | GUID   | Уникальный ID покупателя в системе Мой склад |
| retailStoreId  | GUID   | Уникальный ID рочзничной точки продаж             |
| name           | string | ФИО покупателя                                                      |
| phone          | string | Номер телефона покупателя                                 |
| birthDate      | Date   | Дата рождения покупателя                                   |
| sex            | string | Пол покупателя                                                      |

**Ответ**

201

##### Поиск покупателя

```
GET Loyalty/counterparty?search={{Строка поиска}}
```

В строке для поиска может быть указан номер телефона, ФИО или номер карты лояльности - поиск происходит по частичному совпадению

Ответ масив объектов покупатель

| Атрибут     | Тип | Описание                                                                 |
| ------------------ | ------ | -------------------------------------------------------------------------------- |
| id                 | GUID   | Уникальный ID покупателя в системе Мой склад |
| retailStoreId      | GUID   | Уникальный ID рочзничной точки продаж             |
| name               | string | ФИО покупателя                                                      |
| phone              | string | Номер телефона покупателя                                 |
| birthDate          | Date   | Дата рождения покупателя                                   |
| sex                | string | Пол покупателя                                                      |
| DiscountCardNumber | string | Номер карты покупателя                                       |

##### Получение детальной информации о покупателе

```
POST Loyalty/counterparty/detail
```

| Атрибут | Тип | Описание                                                                 |
| -------------- | ------ | -------------------------------------------------------------------------------- |
| id             | GUID   | Уникальный ID покупателя в системе Мой склад |
| retailStoreId  | GUID   | Уникальный ID рочзничной точки продаж             |
| name           | string | ФИО покупателя                                                      |
| phone          | string | Номер телефона покупателя                                 |
| birthDate      | Date   | Дата рождения покупателя                                   |
| sex            | string | Пол покупателя                                                      |

Ответ

| Атрибут     | Тип | Описание                                                                 |
| ------------------ | ------ | -------------------------------------------------------------------------------- |
| id                 | GUID   | Уникальный ID покупателя в системе Мой склад |
| retailStoreId      | GUID   | Уникальный ID рочзничной точки продаж             |
| name               | string | ФИО покупателя                                                      |
| phone              | string | Номер телефона покупателя                                 |
| birthDate          | Date   | Дата рождения покупателя                                   |
| sex                | string | Пол покупателя                                                      |
| DiscountCardNumber | string | Номер карты покупателя                                       |

##### Расчет скидок для продажи

```
POST Loyalty/RetailDemand/ReCalc
```

| Атрибут        | Тип     | Описание                                                                                                                                             |
| --------------------- | ---------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| id                    | GUID       | Уникальный ID покупателя в системе Мой склад                                                                             |
| retailStoreId         | GUID       | Уникальный ID рочзничной точки продаж                                                                                         |
| name                  | string     | ФИО покупателя                                                                                                                                  |
| phone                 | string     | Номер телефона покупателя                                                                                                             |
| birthDate             | Date       | Дата рождения покупателя                                                                                                               |
| sex                   | string     | Пол покупателя                                                                                                                                  |
| transactionType       | string     | EARNING - если покупатель хочет копить бонусы, SPENDING если покупатель хочет списать бонусы |
| preferredBonusToSpend | int        | Количество бонусов сколько хочет списать покупатель                                                            |
| positions             | position[] | Массив позиций из продажи                                                                                                              |

Объект position

| Атрибут | Тип | Описание                                                                              |
| -------------- | ------ | --------------------------------------------------------------------------------------------- |
| assortmentId   | GUID   | Уникальный ID товара или услуги в системе Мой склад |
| quantity       | int    | количетсво штук                                                                 |
| price          | double | стоимсоть товара или услуги                                           |

Ответ

| Атрибут     | Тип       | Описание                                                                 |
| ------------------ | ------------ | -------------------------------------------------------------------------------- |
| id                 | GUID         | Уникальный ID покупателя в системе Мой склад |
| retailStoreId      | GUID         | Уникальный ID рочзничной точки продаж             |
| name               | string       | ФИО покупателя                                                      |
| phone              | string       | Номер телефона покупателя                                 |
| birthDate          | Date         | Дата рождения покупателя                                   |
| sex                | string       | Пол покупателя                                                      |
| discountCardNumber | string       | Номер карты покупателя                                       |
| positions          | position[]   | Массив позиций из продажи                                  |
| bonusProgram       | bonusProgram | Информация о бонусной программе                      |

Объект position

| Атрибут  | Тип | Описание                                                                              |
| --------------- | ------ | --------------------------------------------------------------------------------------------- |
| assortmentId    | GUID   | Уникальный ID товара или услуги в системе Мой склад |
| quantity        | int    | количетсво штук                                                                 |
| price           | double | стоимсоть товара или услуги                                           |
| discountPercent | double | Размер скидки в процентах                                               |
| discountedPrice | double | Размер скидки в рублях                                                     |

Объект bonusProgram

| Атрибут         | Тип | Описание                                                                                                                                             |
| ---------------------- | ------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| transactionType        | string | EARNING - если покупатель хочет копить бонусы, SPENDING если покупатель хочет списать бонусы |
| agentBonusBalance      | int    | баланс бонусов покупателя                                                                                                             |
| bonusValueToSpend      | int    | Сколько бонусов можно списать                                                                                                      |
| bonusValueToEarn       | int    | Сколько бонусов можно начислить                                                                                                  |
| agentBonusBalanceAfter | int    | Сколько бонусов будет после покупки                                                                                           |
| paidByBonusPoints      | int    | Сколько бонусов потрачено при покупке                                                                                       |

##### Создание продажи

```
POST Loyalty/RetailDemand
```

| Атрибут     | Тип       | Описание                                                                 |
| ------------------ | ------------ | -------------------------------------------------------------------------------- |
| id                 | GUID         | Уникальный ID покупателя в системе Мой склад |
| retailStoreId      | GUID         | Уникальный ID рочзничной точки продаж             |
| name               | string       | ФИО покупателя                                                      |
| phone              | string       | Номер телефона покупателя                                 |
| birthDate          | Date         | Дата рождения покупателя                                   |
| sex                | string       | Пол покупателя                                                      |
| discountCardNumber | string       | Номер карты покупателя                                       |
| positions          | position[]   | Массив позиций из продажи                                  |
| bonusProgram       | bonusProgram | Информация о бонусной программе                      |
| cashSum            | double       | Оплачено наличными                                              |
| noCashSum          | double       | Оплачено безналичным расчетом                         |

Объект position

| Атрибут  | Тип | Описание                                                                              |
| --------------- | ------ | --------------------------------------------------------------------------------------------- |
| assortmentId    | GUID   | Уникальный ID товара или услуги в системе Мой склад |
| quantity        | int    | количетсво штук                                                                 |
| price           | double | стоимсоть товара или услуги                                           |
| discountPercent | double | Размер скидки в процентах                                               |
| discountedPrice | double | Размер скидки в рублях                                                     |

Объект bonusProgram

| Атрибут    | Тип | Описание                                            |
| ----------------- | ------ | ----------------------------------------------------------- |
| bonusValueToSpend | int    | Сколько бонусов можно списать     |
| bonusValueToEarn  | int    | Сколько бонусов можно начислить |

Ответ 201

##### Создание возврата

```
POST Loyalty/RetailSalesReturn
```


| Атрибут     | Тип       | Описание                                                                 |
| ------------------ | ------------ | -------------------------------------------------------------------------------- |
| id                 | GUID         | Уникальный ID покупателя в системе Мой склад |
| retailStoreId      | GUID         | Уникальный ID рочзничной точки продаж             |
| name               | string       | ФИО покупателя                                                      |
| phone              | string       | Номер телефона покупателя                                 |
| birthDate          | Date         | Дата рождения покупателя                                   |
| sex                | string       | Пол покупателя                                                      |
| discountCardNumber | string       | Номер карты покупателя                                       |
| positions          | position[]   | Массив позиций из продажи                                  |
| bonusProgram       | bonusProgram | Информация о бонусной программе                      |
| cashSum            | double       | Оплачено наличными                                              |
| noCashSum          | double       | Оплачено безналичным расчетом                         |

Объект position

| Атрибут  | Тип | Описание                                                                              |
| --------------- | ------ | --------------------------------------------------------------------------------------------- |
| assortmentId    | GUID   | Уникальный ID товара или услуги в системе Мой склад |
| quantity        | int    | количетсво штук                                                                 |
| price           | double | стоимсоть товара или услуги                                           |
| discountPercent | double | Размер скидки в процентах                                               |
| discountedPrice | double | Размер скидки в рублях                                                     |

Объект bonusProgram

| Атрибут    | Тип | Описание                                            |
| ----------------- | ------ | ----------------------------------------------------------- |
| bonusValueToSpend | int    | Сколько бонусов можно списать     |
| bonusValueToEarn  | int    | Сколько бонусов можно начислить |

Ответ 201
