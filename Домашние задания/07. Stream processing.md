## Реализовать сервис заказа. Сервис биллинга. Сервис нотификаций.

При создании пользователя, необходимо создавать аккаунт в сервисе биллинга. В сервисе биллинга должна быть возможность положить деньги на аккаунт и снять деньги.

Сервис нотификаций позволяет отправить сообщение на email. И позволяет получить список сообщений по методу API.

Пользователь может создать заказ. У заказа есть параметр - цена заказа.
Заказ происходит в 2 этапа:

1. сначала снимаем деньги с пользователя с помощью сервиса биллинга
2. отсылаем пользователю сообщение на почту с результатами оформления заказа. Если биллинг подтвердил платеж, должно отослаться письмо счастья. Если нет, то письмо горя.

Упрощаем и считаем, что ничего плохого с сервисами происходить не может (они не могут падать и т.д.). Сервис нотификаций на самом деле не отправляет, а просто сохраняет в БД.

## Архитектура сервиса
Использую событийное взаимодействие с использованием брокера сообщений для нотификаций (уведомлений).
Все уведомления пользователя отправляются в кафку и записываются в бд, для получения списка уведомлений через API.

### Команда для запуска kafka
helm upgrade --install kafka ./kafka --values kafka/values.yaml

## Команда для запуска сервиса без сбора метрик
helm upgrade --install lotus ./lotus --values lotus/values.yaml --set metrics.serviceMonitor.enabled=false

### стартуем тунель чтобы подключаться к нашему сервису локально
minikube tunnel

![07. Stream processing.png](07.%20Stream%20processing.png)

## Сценарий тестирования
### 1. POST /profile/register
#### Регистрация пользователя
#### Проверки:
#### Cтатус код = 201 
#### Записываем email, который был указан при регистрации
### 2. POST /profile/login
#### Авторизация пользователя
#### Проверки:
#### статус код = 200
#### Сохраняем токен авторизации в переменные окружения
### 3. GET /billing/balance
#### Получение баланса пользователя
#### Для запроса используем токен, который был получен на предыдущем шаге
#### Проверки:
#### статус код = 200
#### Проверка, что баланс равен 0
### 4. POST /billing/add-money?money=1000
#### Добавить денег на счет. Кладем 1000 монет.
#### Авторизованный пользователь кладет деньги на счет. После успешного пополнения баланса отправляется уведомление пользователю
#### Проверки:
#### статус код = 200
### 5. POST /billing/withdraw-money?money=100
#### Снятие денег со счета. Снимаем 100 монет.
#### Авторизованный пользователь снимает деньги со счета.
#### После успешного снятия баланс обновляется и отправляется уведомление пользователю.
#### Если денег не достаточно, деньги не снимаются и также отправляется уведомление. 
#### Проверки:
#### статус код = 200
### 6. GET /billing/balance
#### Получение баланса пользователя
#### Для запроса используем токен, который был получен на 2-ом шаге
#### Проверки:
#### статус код = 200
#### Проверка, что баланс равен 900. 1000 монет он закинул и 100 списал, в итоге 900.
### 7. GET /notification
#### Получение уведомлений пользователя
#### Для запроса используем токен, который был получен на 2-ом шаге
#### Проверки:
#### статус код = 200
### 8. GET /order/subscriptions
#### Получение списка подписок
#### Пользователь может запросить какие подписки есть в сервисе, чтобы после их оплатить.
#### Проверки:
#### статус код = 200
### 9. POST /order/pay?idSubscription=1
#### Авторизованный пользователь желает оплатить подписку с idSubscription = 1.
#### Заранее известно, что стоимость подписки 1 равно 10 монет. 
#### Пользователю денег хватает, подписка успешно оплачивается, деньги снимаются со счета.
#### Пользователю отправляется уведомление.
#### Проверки:
#### статус код = 200
### 10. GET /billing/balance
#### Получение баланса пользователя
#### Для запроса используем токен, который был получен на 2-ом шаге. 
#### Хотим проверить баланс пользователя после покупки.
#### Проверки:
#### статус код = 200
#### Проверка, что баланс равен 890. 1000 монет он закинул и 100 списал, и 10 монет оплатил за подписку в итоге 890.
### 11. GET /notification
#### Получение уведомлений пользователя
#### Для запроса используем токен, который был получен на 2-ом шаге.
#### В списке уведомлений желаем обнаружить уведомление о успешной оплате подписки.
#### Проверки:
#### статус код = 200
#### Последнее уведомление пользователя равно "Hello! You pay for order. Order cost amount 10. You balance after 890"
### 12. POST /order/pay?idSubscription=3
#### Авторизованный пользователь желает оплатить подписку с idSubscription = 3.
#### Заранее известно, что стоимость подписки 3 равно 1200 монет.
#### Пользователю денег не хватает, подписка не оплачивается, деньги не снимаются со счета.
#### Пользователю отправляется уведомление.
#### Проверки:
#### статус код = 400
### 13. GET /billing/balance
####  Получение баланса пользователя
####  Для запроса используем токен, который был получен на 2-ом шаге.
####  Хотим проверить баланс пользователя после не успешной покупки.
####  Проверки:
####  статус код = 200
####  Проверка, что баланс равен 890. 1000 монет он закинул и 100 списал, и 10 монет оплатил за подписку в итоге 890.
### 14. GET /notification
####  Получение уведомлений пользователя
####  Для запроса используем токен, который был получен на 2-ом шаге.
####  В списке уведомлений желаем обнаружить уведомление об не успешной оплате подписки.
####  Проверки:
####  статус код = 200
####  Последнее уведомление пользователя равно "Hello! You cannot pay for order. Order cost amount 1200. You balance 890"

Postman коллекция в этом папке
Запустить коллекцию командой
newman run StreamProcessing.postman_collection.json

Результат запуска коллекции
```
newman

Otus with billing

→ profile/register
  POST http://arch.homework/profile/register [201 Created, 335B, 1134ms]
  ✓  Status code is 201
  ✓  set email

→ profile/login
  POST http://arch.homework/profile/login [200 OK, 1.02kB, 369ms]
  ✓  Status code is 200
  ✓  set userId

→ biiling/balance
  GET http://arch.homework/billing/balance [200 OK, 156B, 492ms]
  ✓  Status code is 200
  ✓  Body matches string

→ billing/add-money
  POST http://arch.homework/billing/add-money?money=1000 [200 OK, 99B, 1112ms]
  ✓  Status code is 200

→ billing/withdraw-money
  POST http://arch.homework/billing/withdraw-money?money=100 [200 OK, 99B, 1054ms]
  ✓  Status code is 200

→ biiling/balance after add and withdraw money
  GET http://arch.homework/billing/balance [200 OK, 158B, 25ms]
  ✓  Status code is 200
  ✓  Body matches string

→ notification
  GET http://arch.homework/notification [200 OK, 640B, 88ms]
  ✓  Status code is 200

→ order/subscriptions
  GET http://arch.homework/order/subscriptions [200 OK, 263B, 25ms]
  ✓  Status code is 200

→ order/pay Subscription enough money (Success)
  POST http://arch.homework/order/pay?idSubscription=1 [200 OK, 99B, 1036ms]
  ✓  Status code is 200

→ biiling/balance check after pay order
  GET http://arch.homework/billing/balance [200 OK, 158B, 22ms]
  ✓  Status code is 200
  ✓  Body matches string

→ notification check notification exists
  GET http://arch.homework/notification [200 OK, 814B, 19ms]
  ✓  Status code is 200
  ✓  Body matches string

→ order/pay Subscription not enogh money
  POST http://arch.homework/order/pay?idSubscription=3 [400 Bad Request, 174B, 1049ms]
  ✓  Status code is 400 (Not enough money)

→ biiling/balance check after failed pay order
  GET http://arch.homework/billing/balance [200 OK, 158B, 29ms]
  ✓  Status code is 200
  ✓  Body matches string

→ notification check notification exists about failed
  GET http://arch.homework/notification [200 OK, 992B, 25ms]
  ✓  Status code is 200
  ✓  Body matches string

┌─────────────────────────┬─────────────────────┬────────────────────┐
│                         │            executed │             failed │
├─────────────────────────┼─────────────────────┼────────────────────┤
│              iterations │                   1 │                  0 │
├─────────────────────────┼─────────────────────┼────────────────────┤
│                requests │                  14 │                  0 │
├─────────────────────────┼─────────────────────┼────────────────────┤
│            test-scripts │                  28 │                  0 │
├─────────────────────────┼─────────────────────┼────────────────────┤
│      prerequest-scripts │                  14 │                  0 │
├─────────────────────────┼─────────────────────┼────────────────────┤
│              assertions │                  22 │                  0 │
├─────────────────────────┴─────────────────────┴────────────────────┤
│ total run duration: 7s                                             │
├────────────────────────────────────────────────────────────────────┤
│ total data received: 3.06kB (approx)                               │
├────────────────────────────────────────────────────────────────────┤
│ average response time: 462ms [min: 19ms, max: 1134ms, s.d.: 477ms] │
└────────────────────────────────────────────────────────────────────┘

```